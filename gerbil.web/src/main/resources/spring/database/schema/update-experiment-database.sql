-- New table added for mapping from resultId to resultName (optional but would make the solution cleaner)
CREATE TABLE IF NOT EXISTS ResultNames (
id int GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
name VARCHAR(50)
);
-- Insert records into ResultNames
insert into ResultNames values (0, 'F1 score');
insert into ResultNames values (1, 'Precision');
insert into ResultNames values (2, 'Recall');
insert into ResultNames values (3, 'Area Under Curve');
insert into ResultNames values (4, 'ROC Curve');
insert into ResultNames values (5, 'confidence threshold');
insert into ResultNames values (20, 'avg millis/doc');
insert into ResultNames values (27, 'Error Count');



-- Create Int, Double and Blob results table
-- New table added for int results (e.g., number of errors)
CREATE TABLE IF NOT EXISTS ExperimentTasks_IntResults (
resultId int NOT NULL FOREIGN KEY REFERENCES ResultNames(id),
taskId int NOT NULL FOREIGN KEY REFERENCES ExperimentTasks(id),
resvalue int,
PRIMARY KEY (resultId, taskId)
);

-- ExperimentTasks_AdditionalResults will be renamed to ExperimentTasks_DoubleResults
CREATE TABLE IF NOT EXISTS ExperimentTasks_DoubleResults (
resultId int NOT NULL FOREIGN KEY REFERENCES ResultNames(id),
taskId int NOT NULL FOREIGN KEY REFERENCES ExperimentTasks(id),
resvalue double,
PRIMARY KEY (resultId, taskId)
);

-- New table added for blob results (e.g., ROC)
CREATE TABLE IF NOT EXISTS ExperimentTasks_BlobResults (
resultId int NOT NULL FOREIGN KEY REFERENCES ResultNames(id),
taskId int NOT NULL FOREIGN KEY REFERENCES ExperimentTasks(id),
resvalue BLOB,
PRIMARY KEY (resultId, taskId)
);

--errorCount
insert into ExperimentTasks_IntResults (resultId, taskId, resvalue)
select 27, id, errorCount from ExperimentTasks;
-- copy data from AdditionalResults to double
insert into ExperimentTasks_DoubleResults (resultId, taskId, resvalue)
select resultId, taskId, value from ExperimentTasks_AdditionalResults;
--rocBlob
insert into ExperimentTasks_BlobResults (resultId, taskId, resvalue)
select 29, taskId, roc from ExperimentTasks_ROC;


-- copy data from ExperimentTasks_Version to ExperimentTasks
update ExperimentTasks et set et.version = 
(select ev.version from  ExperimentTasks_Version ev where et.id = ev.id);
-- Alter annotatorName to sysname
ALTER TABLE ExperimentTasks ALTER COLUMN annotatorName RENAME TO systemName;
-- Drop the copied columns from ExperimentTasks
alter table ExperimentTasks
    drop column errorCount ;
-- Drop Version table
drop table ExperimentTasks_Version;
-- Drop AdditionalResults table
drop table ExperimentTasks_AdditionalResults;
-- Drop AdditionalResults table
drop table ExperimentTasks_BlobResults;